name: zzz [DO NOT RUN] Automated unit tests

on:
  workflow_dispatch: # TODO: remove this after testing
  pull_request:
    branches: [trio_tests_ci]
  push:
    branches: [trio_tests_ci]

jobs:
  test:
    name: Run Unit Tests
    runs-on: macos-15
    #if: github.repository_owner == 'nightscout' TODO: include this if-statement after testing

    steps:
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.3.app/Contents/Developer

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install xcpretty
        run: gem install xcpretty
      
      - name: Build for testing
        run: |
          set -o pipefail && \
          xcodebuild build-for-testing \
            -workspace Trio.xcworkspace \
            -scheme "Trio Tests" \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.4' \
            | xcpretty
      
      - name: Run Trio unit tests
        run: |
          mkdir -p test-results
          set -o pipefail && \
          xcodebuild test-without-building \
            -workspace Trio.xcworkspace \
            -scheme "Trio Tests" \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.4' \
            | xcpretty --test --report junit --output test-results/TrioTests.xml
      
        # Mark that failure of this step shouldn't block following ones
        continue-on-error: true
      
      - name: Run Trio Watch App unit tests
        if: always()
        run: |
          mkdir -p test-results
          set -o pipefail && \
          xcodebuild test-without-building \
            -workspace Trio.xcworkspace \
            -scheme "Trio Watch AppTests" \
            -destination 'platform=watchOS Simulator,name=Apple Watch Series 10 (46mm),OS=11.4' \
            | xcpretty --test --report junit --output test-results/WatchAppTests.xml
      
        continue-on-error: true
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-test-results
          path: test-results/
      
      - name: Publish Test Report
        if: always()
        uses: dorny/test-reporter@v1
        with:
          name: Xcode Tests
          path: test-results/*.xml
          reporter: java-junit
        