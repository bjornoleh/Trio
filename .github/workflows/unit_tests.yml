name: zzz [DO NOT RUN] Automated unit tests

on:
  workflow_dispatch: # TODO: remove this after testing
  pull_request:
    branches: [trio_tests_ci_no_scheme_changes]
  push:
    branches: [trio_tests_ci_no_scheme_changes]

jobs:
  test:
    name: Run Unit Tests
    runs-on: macos-15
    #if: github.repository_owner == 'nightscout' TODO: include this if-statement after testing

    steps:
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.3.app/Contents/Developer

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Build for testing
        run: |
          set -o pipefail && \
          time xcodebuild build-for-testing \
            -workspace Trio.xcworkspace \
            -scheme "Trio Tests" \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.4' \
      
      - name: Run Trio unit tests
        run: |
          set -o pipefail && \
          time xcodebuild test-without-building \
            -workspace Trio.xcworkspace \
            -scheme "Trio Tests" \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.4' \
            -resultBundlePath TestResults.xcresult
            2>&1 | tee xcodebuild.log
        continue-on-error: true

      - name: Annotate test results
        if: always()
        run: |
          summary_line=$(grep -E "Test run with [0-9]+ tests (failed|passed)" xcodebuild.log | head -n1)

          if echo "$summary_line" | grep -q "failed"; then
            echo "::error title=Unit Tests Failed::$summary_line"

            echo "##[error]âŒ Some tests failed:"
            grep -A 10 "Failing tests:" xcodebuild.log | \
              sed -n '/Failing tests:/,/^[^ ]/p' | \
              grep -E '^\s+[A-Za-z0-9]+\..+\(\)' | \
              sed 's/^/  - /' >> $GITHUB_STEP_SUMMARY

            echo "::group::Failed Test List"
            grep -A 10 "Failing tests:" xcodebuild.log | \
              grep -E '^\s+[A-Za-z0-9]+\..+\(\)' | \
              sed 's/^/  - /'
            echo "::endgroup::"

          else
            echo "::notice title=Unit Tests Passed::âœ… All tests passed"
          fi

          - name: Convert .xcresult to JUnit XML
          run: |
            brew install chargepoint/xcparse/xcparse || echo "xcparse already installed"
            mkdir -p test-results
            xcparse junit --output test-results TestResults.xcresult

          - name: Publish test results
          uses: dorny/test-reporter@v1
          if: always()
          with:
            name: Unit Tests
            path: test-results/*.xml
            reporter: java-junit
          
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-test-artifacts
          path: |
            TestResults.xcresult
            test-results

      - name: Annotate summary
        if: always()
        run: |
          total=$(grep -o 'testsuite tests="[0-9]*"' test-results/*.xml | sed 's/[^0-9]*//g')
          failures=$(grep -o 'failures="[0-9]*"' test-results/*.xml | sed 's/[^0-9]*//g')
          echo "## ðŸ§ª Unit Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "**Total tests:** $total" >> $GITHUB_STEP_SUMMARY
          echo "**Failures:** $failures" >> $GITHUB_STEP_SUMMARY