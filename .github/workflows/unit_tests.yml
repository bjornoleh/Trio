name: Swift Tests

on:
  workflow_dispatch: # TODO: remove this after testing
  pull_request:
    branches: [unit_tests_on_PR]
  push:
    branches: [unit_tests_on_PR]

jobs:
  test:
    name: Run Unit Tests
    runs-on: macos-15

    steps:
      - name: Select Xcode version
        run: sudo xcode-select -s /Applications/Xcode_16.3.app/Contents/Developer

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Install xcpretty
        run: gem install xcpretty

      - name: Build for testing
        run: |
          xcodebuild build-for-testing \
            -scheme "Trio Tests" \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.4' \
            -skip-package-plugin-validation \
            -only-testing:TrioTests \
            | xcpretty
            
      - name: Run tests
        run: |
          xcodebuild test-without-building \
            -scheme "Trio Tests" \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 16,OS=18.4' \
            -only-testing:TrioTests \
            | xcpretty
            
      # watchOS Unit Tests
      - name: Run watchOS Unit Tests
        run: |
          set -o pipefail && \
          xcodebuild test \
            -scheme "Trio Watch AppTests" \
            -destination 'platform=watchOS Simulator,name=Apple Watch Series 9 (45mm),OS=10.4' \
            | xcpretty --test --color --report html --output WatchOSTests.html

      # Upload test logs and reports
      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: xcode-test-artifacts
          path: |
            iOSTests.html
            WatchOSTests.html
